<div class="dashboard-layout">
  <main class="admin-page">
    
    <header class="admin-top-bar" style="display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 30px;">
      
      <div class="top-bar-side" style="flex: 1; display: flex; justify-content: flex-start;">
        @if (!isReadOnly()) {
          <button mat-stroked-button class="btn-new" (click)="navigateToAdd()">
            <mat-icon>add</mat-icon> {{'DASHBOARD.NEW_PERFORMANCE' | translate}}
          </button>
        }
      </div>
      
      <div class="header-center" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;">
        
        <h1 class="header-title" style="margin: 0; display: flex; align-items: center; gap: 10px;">
          {{'DASHBOARD.DASHBOARD' | translate}}
          @if (isReadOnly()) {
            <mat-icon style="color: #888; font-size: 20px; width: 20px; height: 20px;" [title]="'DASHBOARD.READ_ONLY_ARCHIVE' | translate">lock</mat-icon>
          }
        </h1>
        
        <mat-form-field appearance="outline" subscriptSizing="dynamic" style="width: 100%; min-width: 250px; max-width: 350px;">
          <mat-select [value]="festival()?.id" (selectionChange)="onFestivalChange($event.value)">
            @for (f of allFestivals(); track f.id) {
              <mat-option [value]="f.id">
                {{ f.name }}
                @if (f.status === 'completed') { <span style="font-size: 0.8em;">({{ 'FESTIVAL.FINISHED' | translate }})</span> }
                @if (f.status === 'draft') { <span style="font-size: 0.8em;">({{ 'FESTIVAL.DRAFT' | translate }})</span> }
                @if (f.status === 'ongoing') { <span style="font-size: 0.8em;">({{ 'FESTIVAL.ONGOING' | translate }})</span> }
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

      </div>
      
      <div class="top-bar-side right-align" style="flex: 1; display: flex; justify-content: flex-end;">
        <button mat-button routerLink="/admin/festivals">
          <mat-icon>arrow_back</mat-icon> {{ 'COMMON.BACK' | translate }}
        </button>
      </div>

    </header>

    @if (isLoading()) {
      <div class="spinner-container">
        <mat-spinner diameter="50" color="primary"></mat-spinner>
      </div>
    }

    @if (!isLoading() && !festival()) {
      <div class="empty-state" style="text-align: center; padding: 40px; border: 2px dashed #ccc; border-radius: 12px; margin-top: 20px;">
        <mat-icon style="font-size: 48px; width: 48px; height: 48px; color: #ccc; margin-bottom: 16px;">event_busy</mat-icon>
        <h2>{{ 'DASHBOARD.FESTIVAL_NOT_FOUND' | translate }}</h2>
        <p>{{ 'DASHBOARD.FESTIVAL_NOT_FOUND_DESC' | translate }}</p>
        <button mat-flat-button color="primary" routerLink="/admin/festivals" style="margin-top: 16px;">
          {{ 'DASHBOARD.BACK_TO_ADMIN' | translate }}
        </button>
      </div>
    }

    @if (!isLoading() && festival() && performanceGroups().length === 0) {
      <div class="empty-state" style="text-align: center; padding: 40px;">
        <p>{{'DASHBOARD.NOTHING' | translate}}</p>
        @if (!isReadOnly()) {
          <button mat-button color="primary" (click)="navigateToAdd()">{{'DASHBOARD.ADD' | translate}}</button>
        }
      </div>
    }

    @for (group of performanceGroups(); track group.date) {
      <section class="admin-section">
        
        <h2 class="section-label">
          {{ group.date | date:'EEEE d MMMM' : undefined : currentLang() | titlecase }}
        </h2>
        
        <div class="grid-table-container">
          <table mat-table [dataSource]="group.performances" class="festify-grid-table">

            <ng-container matColumnDef="artist">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.ARTIST' | translate}} </th>
              <td mat-cell *matCellDef="let perf" class="bold-text"> 
                {{ perf.artist?.name || ('DASHBOARD.UNKNOWN' | translate) }} 
              </td>
            </ng-container>

            <ng-container matColumnDef="title">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.TITLE' | translate}} </th>
              <td mat-cell *matCellDef="let perf"> {{ perf.title }} </td>
            </ng-container>

            <ng-container matColumnDef="stage">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.STAGE' | translate}} </th>
              <td mat-cell *matCellDef="let perf"> {{ perf.stage?.name || ('DASHBOARD.NA' | translate) }} </td>
            </ng-container>

            <ng-container matColumnDef="start_at">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.START' | translate}} </th>
              <td mat-cell *matCellDef="let perf"> 
                {{ perf.start_at | date:'HH:mm' : undefined : currentLang() }} 
              </td>
            </ng-container>

            <ng-container matColumnDef="end_at">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.END' | translate}} </th>
              <td mat-cell *matCellDef="let perf"> 
                {{ perf.end_at | date:'HH:mm' : undefined : currentLang() }} 
              </td>
            </ng-container>

             <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.NOTE' | translate}} </th>
              <td mat-cell *matCellDef="let perf" class="desc-cell">
                {{ perf.description | slice:0:25 }}{{ perf.description && perf.description.length > 25 ? '...' : '' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="price">
              <th mat-header-cell *matHeaderCellDef> {{'FORM_ADD_PERFORMANCES.PRICE' | translate}} </th>
              <td mat-cell *matCellDef="let perf"> 
                {{ perf.price | currency:'USD':'symbol':'1.0-0' }} 
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="text-center"> {{'DASHBOARD.ACTION' | translate}} </th>
              <td mat-cell *matCellDef="let perf" class="action-cell" style="text-align: center;">
                
                @if (!isReadOnly()) {
                  <button class="icon-btn edit" (click)="navigateToEdit(perf.id!)" [title]="'COMMON.EDIT' | translate">
                    <mat-icon>edit_square</mat-icon>
                  </button>
                  <button class="icon-btn trash" (click)="deletePerformance(perf.id!)" [title]="'COMMON.DELETE' | translate">
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                } @else {
                  <mat-icon style="color: #ccc; font-size: 20px; width: 20px; height: 20px; cursor: not-allowed;" [title]="'DASHBOARD.EDIT_IMPOSSIBLE' | translate">block</mat-icon>
                }

              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </section>
    }
  </main>
</div>

<ng-template #confirmDialogTemplate>
  <h2 mat-dialog-title>{{ 'DASHBOARD.DELETE_CONFIRM_TITLE' | translate }}</h2>
  <mat-dialog-content>
    <p>{{ 'DASHBOARD.DELETE_CONFIRM_BODY' | translate }}</p>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>{{ 'COMMON.CANCEL' | translate }}</button>
    <button mat-flat-button color="warn" [mat-dialog-close]="true">{{ 'COMMON.DELETE' | translate }}</button>
  </mat-dialog-actions>
</ng-template>