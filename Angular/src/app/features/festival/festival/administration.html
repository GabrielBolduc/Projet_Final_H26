<div class="admin-page">

  <header class="admin-top-bar">
    <div class="top-bar-side">
      <button mat-stroked-button class="btn-new" (click)="navigateToAdd()">
        <mat-icon>add</mat-icon>
        Nouveau Festival
      </button>
    </div>

    <h1 class="header-title">{{'FESTIVAL.ADMINISTRATION' | translate}}</h1>

    <div class="top-bar-side right-align">
      <span class="greeting">{{'FESTIVAL.HELLO' | translate}}</span>
    </div>
  </header>

  <main>
    @if (currentFestival(); as f) {
    <section class="admin-section">
      <h2 class="section-label">{{'FESTIVAL.CURRENT_FESTIVAL' | translate}}</h2>

      <mat-card class="fest-card">
        <mat-card-content class="card-content-layout">
          <div class="main-info">
            <h3>
              {{ f.name }}
              <span class="status-badge ongoing">{{'FESTIVAL.ONGOING' | translate}}</span>
            </h3>

            <div class="meta-info">
              <mat-icon>calendar_today</mat-icon>
              <span>{{ f.start_at | date:'d MMMM' }} - {{ f.end_at | date:'d MMMM yyyy' }}</span>
            </div>

            <p><strong>{{'FESTIVAL.ADRESS' | translate}}</strong> {{ f.address }}</p>

            <button mat-flat-button color="primary" class="btn-dash" [routerLink]="['/admin/festivals', f.id, 'dashboard']">
              {{'FESTIVAL.ACCESS_DASHBOARD' | translate}}
            </button>
          </div>

          <div class="card-actions-side">
            <button class="icon-btn finish" (click)="openFinishDialog(f)" title="Terminer et archiver">
              <mat-icon>check_circle_outline</mat-icon>
            </button>

            <button class="icon-btn edit" (click)="navigateToEdit(f.id)" title="Modifier">
              <mat-icon>edit_square</mat-icon>
            </button>
            
            <button class="icon-btn trash" [disabled]="f.status === 'ongoing'" (click)="deleteFestival(f)" title="Supprimer">
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </section>
    }

    @if (drafts().length > 0) {
    <section class="admin-section">
      <h2 class="section-label">{{'FESTIVAL.DRAFTS' | translate}}</h2>

      <div class="archive-grid">
        @for (f of drafts(); track f.id) {
        <mat-card class="fest-card">
          <mat-card-content class="card-content-layout">
            <div class="main-info">
              <h3>
                {{ f.name }} 
                <span class="status-badge draft">{{'FESTIVAL.DRAFT' | translate}}</span>
              </h3>

              <div class="meta-info">
                <mat-icon>calendar_today</mat-icon>
                <span>{{ f.start_at | date:'d MMMM' }} - {{ f.end_at | date:'d MMMM yyyy' }}</span>
              </div>

              <p><strong>{{'FESTIVAL.ADRESS' | translate}}</strong> {{ f.address }}</p>
              
              <button mat-flat-button color="primary" class="btn-dash" [routerLink]="['/admin/festivals', f.id, 'dashboard']">
                {{'FESTIVAL.ACCESS_DASHBOARD' | translate}}
              </button>
            </div>

            <div class="card-actions-side">
              <button class="icon-btn edit" (click)="navigateToEdit(f.id)" title="Modifier">
                <mat-icon>edit_square</mat-icon>
              </button>
              <button class="icon-btn trash" (click)="deleteFestival(f)" title="Supprimer">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </mat-card-content>
        </mat-card>
        }
      </div>
    </section>
    }

    @if (archives().length > 0) {
    <section class="admin-section">
      <h2 class="section-label">{{'FESTIVAL.ARCHIVE' | translate}}</h2>

      <div class="archive-grid">
        @for (f of archives(); track f.id) {
        <mat-card class="fest-card archived">
          <mat-card-content class="card-content-layout">
            <div class="main-info">
              <h3>
                {{ f.name }} 
                <span class="status-badge">{{'FESTIVAL.FINISHED' | translate}}</span>
              </h3>

              <div class="meta-info">
                <mat-icon>calendar_today</mat-icon>
                <span>{{ f.start_at | date:'d MMMM' }} - {{ f.end_at | date:'d MMMM yyyy' }}</span>
              </div>

              <p><strong>{{'FESTIVAL.ADRESS' | translate}}</strong> {{ f.address }}</p>
              
              <button mat-flat-button color="primary" class="btn-dash" [routerLink]="['/admin/festivals', f.id, 'dashboard']" style="margin-bottom: 10px;">
                {{'FESTIVAL.ACCESS_DASHBOARD' | translate}}
              </button>

              <div class="kpi-summary" style="margin-top: 10px; font-size: 0.9rem; color: #666; display: flex; align-items: center; gap: 15px;">
                <span style="display: flex; align-items: center; gap: 4px;">
                  <mat-icon inline style="color: #ffb400;">star</mat-icon> {{f.satisfaction}} / 5
                </span>
                <span style="display: flex; align-items: center; gap: 4px;">
                  <mat-icon inline color="primary">trending_up</mat-icon> {{f.other_income | currency:'USD':'symbol':'1.0-0'}}
                </span>
                <span style="display: flex; align-items: center; gap: 4px;">
                  <mat-icon inline color="warn">trending_down</mat-icon> {{f.other_expense | currency:'USD':'symbol':'1.0-0'}}
                </span>

                @if (f.comment) {
                  <button mat-button class="btn-notes" (click)="showNotes(f)">
                    <mat-icon inline>notes</mat-icon> Voir les notes
                  </button>
                }
              </div>
            </div>

            <div class="card-actions-side">
              <button class="icon-btn edit" (click)="navigateToEdit(f.id)" title="Modifier">
                <mat-icon>edit_square</mat-icon>
              </button>
              <button class="icon-btn trash" (click)="deleteFestival(f)" title="Supprimer">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </mat-card-content>
        </mat-card>
        }
      </div>
    </section>
    }
  </main>
</div>

<ng-template #confirmDialogTemplate>
  <h2 mat-dialog-title>Supprimer ce festival ?</h2>
  <mat-dialog-content>
    <p>Êtes-vous sûr de vouloir supprimer définitivement ce festival ? Toutes les données rattachées seront effacées.</p>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Annuler</button>
    <button mat-flat-button color="warn" [mat-dialog-close]="true">Supprimer</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #finishDialogTemplate let-data>
  <h2 mat-dialog-title>Terminer le festival</h2>
  <mat-dialog-content>
    <p>{{data.name}}</p>
    
    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
      <mat-form-field appearance="outline">
        <mat-label>Satisfaction (1 - 5)</mat-label>
        <input matInput type="number" [(ngModel)]="data.satisfaction" min="1" max="5">
        <mat-icon matSuffix>star</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Autres revenus</mat-label>
        <input matInput type="number" [(ngModel)]="data.other_income">
        <mat-icon matSuffix>attach_money</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Autres dépenses</mat-label>
        <input matInput type="number" [(ngModel)]="data.other_expense">
        <mat-icon matSuffix>money_off</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Notes</mat-label>
        <textarea matInput [(ngModel)]="data.comment" rows="3"></textarea>
      </mat-form-field>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Annuler</button>
    <button mat-flat-button color="primary" [mat-dialog-close]="data">Confirmer et Archiver</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #notesDialogTemplate let-data>
  <h2 mat-dialog-title class="dialog-title-custom">Notes : {{ data.name }}</h2>
  <mat-dialog-content>
    <div class="notes-display-box">
      {{ data.comment }}
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-flat-button color="accent" mat-dialog-close>Fermer</button>
  </mat-dialog-actions>
</ng-template>