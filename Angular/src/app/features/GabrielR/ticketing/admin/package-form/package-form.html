<mat-card class="perf-card package-card">
  <h2>{{ isEditMode() ? ('PACKAGE_FORM.EDIT_TITLE' | translate) : ('PACKAGE_FORM.NEW_TITLE' | translate) }}</h2>

  <div class="package-layout">
    
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="perf-form">
      
      @if (serverErrors().length > 0) {
        <div class="form-error">
          @for (error of serverErrors(); track $index) {
            <div>{{ error }}</div>
          }
        </div>
      }

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ 'PACKAGE_FORM.PACKAGE_TITLE' | translate }}</mat-label>
        <input matInput formControlName="title" [placeholder]="'PACKAGE_FORM.TITLE_PLACEHOLDER' | translate">
        @if (form.get('title')?.hasError('required')) {
          <mat-error>{{ 'PACKAGE_FORM.REQUIRED' | translate }}</mat-error>
        }
        @if (form.get('title')?.hasError('maxlength')) {
          <mat-error>{{ 'PACKAGE_FORM.MAX_50' | translate }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ 'PACKAGE_FORM.DESCRIPTION' | translate }}</mat-label>
        <textarea matInput formControlName="description" rows="3"></textarea>
        @if (form.get('description')?.hasError('maxlength')) {
          <mat-error>{{ 'PACKAGE_FORM.MAX_100' | translate }}</mat-error>
        }
      </mat-form-field>

      <div class="grid-row-2">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'PACKAGE_FORM.PRICE' | translate }}</mat-label>
          <input matInput type="number" formControlName="price">
          @if (form.get('price')?.hasError('required')) {
            <mat-error>{{ 'PACKAGE_FORM.REQUIRED' | translate }}</mat-error>
          }
          @if (form.get('price')?.hasError('min')) {
            <mat-error>{{ 'PACKAGE_FORM.PRICE_INVALID' | translate }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'PACKAGE_FORM.QUOTA' | translate }}</mat-label>
          <input matInput type="number" formControlName="quota">
          @if (form.get('quota')?.hasError('required')) {
            <mat-error>{{ 'PACKAGE_FORM.REQUIRED' | translate }}</mat-error>
          }
          @if (form.get('quota')?.hasError('max')) {
            <mat-error>{{ 'PACKAGE_FORM.MAX_PLACES' | translate:{cap: festivalCapacity()} }}</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="grid-row-2">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'PACKAGE_FORM.START_DATE' | translate }}</mat-label>
          <input matInput [matDatepicker]="pickerStart" formControlName="valid_date">
          <mat-datepicker-toggle matIconSuffix [for]="pickerStart"></mat-datepicker-toggle>
          <mat-datepicker #pickerStart></mat-datepicker>
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>{{ 'PACKAGE_FORM.TIME' | translate }}</mat-label>
          <input matInput type="time" formControlName="valid_time">
        </mat-form-field>
      </div>

      <div class="grid-row-2">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'PACKAGE_FORM.END_DATE' | translate }}</mat-label>
          <input matInput [matDatepicker]="pickerEnd" formControlName="expired_date">
          <mat-datepicker-toggle matIconSuffix [for]="pickerEnd"></mat-datepicker-toggle>
          <mat-datepicker #pickerEnd></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>{{ 'PACKAGE_FORM.TIME' | translate }}</mat-label>
          <input matInput type="time" formControlName="expired_time">
        </mat-form-field>
      </div>

      @if (form.hasError('dateRangeInvalid') && (form.get('expired_date')?.touched || form.get('expired_time')?.touched)) {
        <div class="time-error">
          {{ 'PACKAGE_FORM.END_AFTER_START' | translate }}
        </div>
      }
      @if (form.hasError('validBeforeFestival') && (form.get('valid_date')?.touched || form.get('valid_time')?.touched)) {
        <div class="time-error">
          {{ 'PACKAGE_FORM.START_BEFORE_FESTIVAL' | translate:{ date: (festivalStartLimit() | date:'shortDate') } }}
        </div>
      }
      @if (form.hasError('expiredAfterFestival') && (form.get('expired_date')?.touched || form.get('expired_time')?.touched)) {
        <div class="time-error">
          {{ 'PACKAGE_FORM.END_AFTER_FESTIVAL' | translate:{ date: (festivalEndLimit() | date:'shortDate') } }}
        </div>
      }

      <div class="grid-row-2 file-category-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'PACKAGE_FORM.TYPE' | translate }}</mat-label>
          <mat-select formControlName="category">
            <mat-option value="general">{{ 'PACKAGE_FORM.TYPE_GENERAL' | translate }}</mat-option>
            <mat-option value="daily">{{ 'PACKAGE_FORM.TYPE_DAILY' | translate }}</mat-option>
            <mat-option value="evening">{{ 'PACKAGE_FORM.TYPE_EVENING' | translate }}</mat-option>
          </mat-select>
        </mat-form-field>

        <div class="image-upload-wrapper">
          <div class="file-input-container">
            <button type="button" mat-stroked-button (click)="fileInput.click()">
              <mat-icon>image</mat-icon> {{ 'PACKAGE_FORM.BACKGROUND_IMAGE' | translate }}
            </button>
            <input #fileInput type="file" (change)="onFileSelected($event)" style="display:none" accept="image/jpeg,image/png,image/webp">
            @if (selectedFile) { <span class="file-name">{{ selectedFile.name }}</span> }
          </div>

          @if (displayImageUrl()) {
            <div class="image-thumbnail">
              <img [src]="displayImageUrl()" alt="AperÃ§u de l'image du billet">
            </div>
          }
        </div>
      </div>

      <div class="form-actions">
        <button mat-stroked-button type="button" routerLink="/admin/ticketing" class="action-btn cancel-btn">
          {{ 'PACKAGE_FORM.CANCEL' | translate }}
        </button>
        
        <button mat-flat-button color="primary" type="submit" class="action-btn submit-btn" [disabled]="form.invalid || isLoading()">
          @if (isLoading()) {
            <span>{{ 'PACKAGE_FORM.PROCESSING' | translate }}</span> 
          } @else {
            {{ isEditMode() ? ('PACKAGE_FORM.UPDATE' | translate) : ('PACKAGE_FORM.SAVE' | translate) }}
          }
        </button>
      </div>
    </form>
  </div>
</mat-card>