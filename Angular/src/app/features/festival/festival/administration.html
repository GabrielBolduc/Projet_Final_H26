<div class="admin-page">

  <header class="admin-top-bar">
    <div class="top-bar-side">
      <button mat-stroked-button class="btn-new" (click)="navigateToAdd()">
        <mat-icon>add</mat-icon>
        {{'FESTIVAL.NEW_FESTIVAL' | translate}}
      </button>
    </div>

    <h1 class="header-title">{{'FESTIVAL.ADMINISTRATION' | translate}}</h1>

    <div class="top-bar-side right-align">
      <span class="greeting">{{'FESTIVAL.HELLO' | translate}}</span>
    </div>
  </header>

  <main>
    @if (currentFestival(); as f) {
    <section class="admin-section">
      <h2 class="section-label">{{'FESTIVAL.CURRENT_FESTIVAL' | translate}}</h2>

      <mat-card class="fest-card">
        <mat-card-content class="card-content-layout">
          <div class="main-info">
            <h3>
              {{ f.name }}
              <span class="status-badge ongoing">{{'FESTIVAL.ONGOING' | translate}}</span>
            </h3>

            <div class="meta-info">
              <mat-icon>calendar_today</mat-icon>
              <span>{{ f.start_at | date:'d MMMM' }} - {{ f.end_at | date:'d MMMM yyyy' }}</span>
            </div>

            <div class="extended-details">
              <span class="info-item">
                <mat-icon inline>groups</mat-icon>
                <strong>{{'FESTIVAL.DAILY_CAPACITY' | translate}}:</strong> {{ f.daily_capacity }}
              </span>
              <span class="info-item">
                <mat-icon inline>explore</mat-icon>
                <strong>Lat:</strong> {{ f.latitude }} | <strong>Lng:</strong> {{ f.longitude }}
              </span>
            </div>

            <p class="address-text"><strong>{{'FESTIVAL.ADRESS' | translate}}</strong> {{ f.address }}</p>

            <button mat-flat-button color="primary" class="btn-dash" [routerLink]="['/admin/festivals', f.id, 'dashboard']">
              {{'FESTIVAL.ACCESS_DASHBOARD' | translate}}
            </button>
          </div>

          <div class="card-actions-side">
            <button class="icon-btn finish" (click)="openFinishDialog(f)" [title]="'COMMON.SAVE' | translate">
              <mat-icon>check_circle_outline</mat-icon>
            </button>

            <button class="icon-btn edit" (click)="navigateToEdit(f.id)" [title]="'FESTIVAL.UPDATE' | translate">
              <mat-icon>edit_square</mat-icon>
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </section>
    }

    @if (drafts().length > 0) {
    <section class="admin-section">
      <h2 class="section-label">{{'FESTIVAL.DRAFTS' | translate}}</h2>

      <div class="archive-grid">
        @for (f of drafts(); track f.id) {
        <mat-card class="fest-card">
          <mat-card-content class="card-content-layout">
            <div class="main-info">
              <h3>
                {{ f.name }} 
                <span class="status-badge draft">{{'FESTIVAL.DRAFT' | translate}}</span>
              </h3>

              <div class="meta-info">
                <mat-icon>calendar_today</mat-icon>
                <span>{{ f.start_at | date:'d MMMM' }} - {{ f.end_at | date:'d MMMM yyyy' }}</span>
              </div>

              <div class="extended-details">
                <span class="info-item">
                  <mat-icon inline>groups</mat-icon>
                  <strong>{{'FESTIVAL.DAILY_CAPACITY' | translate}}:</strong> {{ f.daily_capacity }}
                </span>
                <span class="info-item">
                  <mat-icon inline>explore</mat-icon>
                  <strong>Lat:</strong> {{ f.latitude }} | <strong>Lng:</strong> {{ f.longitude }}
                </span>
              </div>

              <p class="address-text"><strong>{{'FESTIVAL.ADRESS' | translate}}</strong> {{ f.address }}</p>
              
              <button mat-flat-button color="primary" class="btn-dash" [routerLink]="['/admin/festivals', f.id, 'dashboard']">
                {{'FESTIVAL.ACCESS_DASHBOARD' | translate}}
              </button>
            </div>

            <div class="card-actions-side">
              <button class="icon-btn edit" (click)="navigateToEdit(f.id)" [title]="'FESTIVAL.UPDATE' | translate">
                <mat-icon>edit_square</mat-icon>
              </button>
              <button class="icon-btn trash" (click)="deleteFestival(f)" [title]="'COMMON.DELETE' | translate">
                <mat-icon>delete_outline</mat-icon>
              </button>
            </div>
          </mat-card-content>
        </mat-card>
        }
      </div>
    </section>
    }

    @if (archives().length > 0) {
    <section class="admin-section">
      <h2 class="section-label">{{'FESTIVAL.ARCHIVE' | translate}}</h2>

      <div class="archive-grid">
        @for (f of archives(); track f.id) {
        <mat-card class="fest-card archived">
          <mat-card-content class="card-content-layout">
            <div class="main-info">
              <h3>
                {{ f.name }} 
                <span class="status-badge">{{'FESTIVAL.FINISHED' | translate}}</span>
              </h3>

              <div class="meta-info">
                <mat-icon>calendar_today</mat-icon>
                <span>{{ f.start_at | date:'d MMMM' }} - {{ f.end_at | date:'d MMMM yyyy' }}</span>
              </div>

              <div class="extended-details">
                <span class="info-item">
                  <mat-icon inline>groups</mat-icon>
                  <strong>{{'FESTIVAL.DAILY_CAPACITY' | translate}}:</strong> {{ f.daily_capacity }}
                </span>
                <span class="info-item">
                  <mat-icon inline>explore</mat-icon>
                  <strong>Lat:</strong> {{ f.latitude }} | <strong>Lng:</strong> {{ f.longitude }}
                </span>
              </div>

              <p class="address-text"><strong>{{'FESTIVAL.ADRESS' | translate}}</strong> {{ f.address }}</p>
              
              <button mat-flat-button color="primary" class="btn-dash" [routerLink]="['/admin/festivals', f.id, 'dashboard']">
                {{'FESTIVAL.ACCESS_DASHBOARD' | translate}}
              </button>

              <div class="kpi-summary">
                <span class="info-item">
                  <mat-icon inline style="color: #ffb400;">star</mat-icon> {{f.satisfaction}} / 5
                </span>
                <span class="info-item">
                  <mat-icon inline color="primary">trending_up</mat-icon> {{f.other_income | currency:'USD':'symbol':'1.0-0'}}
                </span>
                <span class="info-item">
                  <mat-icon inline color="warn">trending_down</mat-icon> {{f.other_expense | currency:'USD':'symbol':'1.0-0'}}
                </span>

                @if (f.comment && f.comment.trim().length > 0) {
                  <button mat-button class="btn-notes" (click)="showNotes(f)">
                    <mat-icon inline>notes</mat-icon> {{ 'DASHBOARD.NOTE' | translate }}
                  </button>
                } @else {
                  <span style="color: #999; font-style: italic; font-size: 0.85em; margin-left: 10px;">Aucune note</span> 
                }
              </div>
            </div>

            <div class="card-actions-side">
              <button class="icon-btn edit" (click)="navigateToEdit(f.id)" [title]="'FESTIVAL.UPDATE' | translate">
                <mat-icon>edit_square</mat-icon>
              </button>
            </div>
          </mat-card-content>
        </mat-card>
        }
      </div>
    </section>
    }
  </main>
</div>

<ng-template #confirmDialogTemplate>
  <h2 mat-dialog-title>{{ 'COMMON.DELETE' | translate }} ?</h2>
  <mat-dialog-content>
    <p>{{ 'ACCOMMODATIONS.FORM.DELETE_CONFIRM' | translate }}</p> 
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>{{ 'COMMON.CANCEL' | translate }}</button>
    <button mat-flat-button color="warn" [mat-dialog-close]="true">{{ 'COMMON.DELETE' | translate }}</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #finishDialogTemplate let-data>
  <h2 mat-dialog-title>{{ 'FESTIVAL.FINISHED' | translate }}</h2>
  <mat-dialog-content>
    <p>{{data.name}}</p>
    
    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'FESTIVAL.SATISFACTION' | translate }} (1 - 5)</mat-label>
        <input matInput type="number" [(ngModel)]="data.satisfaction" min="1" max="5">
        <mat-icon matSuffix>star</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>{{ 'FESTIVAL.OTHER_INCOME' | translate }}</mat-label>
        <input matInput type="number" [(ngModel)]="data.other_income">
        <mat-icon matSuffix>attach_money</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>{{ 'FESTIVAL.OTHER_EXPENSE' | translate }}</mat-label>
        <input matInput type="number" [(ngModel)]="data.other_expense">
        <mat-icon matSuffix>money_off</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>{{ 'DASHBOARD.NOTE' | translate }}</mat-label>
        <textarea matInput [(ngModel)]="data.comment" rows="3"></textarea>
      </mat-form-field>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>{{ 'COMMON.CANCEL' | translate }}</button>
    <button mat-flat-button color="primary" [mat-dialog-close]="data">{{ 'COMMON.SAVE' | translate }}</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #notesDialogTemplate let-data>
  <h2 mat-dialog-title class="dialog-title-custom">{{ 'DASHBOARD.NOTE' | translate }} : {{ data.name }}</h2>
  <mat-dialog-content>
    <div class="notes-display-box">
      {{ data.comment }}
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-flat-button color="accent" mat-dialog-close>{{ 'COMMON.CANCEL' | translate }}</button>
  </mat-dialog-actions>
</ng-template>