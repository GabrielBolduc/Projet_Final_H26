<div class="dashboard-layout">
  <main class="admin-page">
    
    <header class="admin-top-bar">
      <button mat-stroked-button class="btn-new" (click)="navigateToAdd()" [disabled]="!festivalId()">
        <mat-icon>add</mat-icon>{{'DASHBOARD.NEW_PERFORMANCE' | translate}}
      </button>
      
      <h1 class="header-title">{{'DASHBOARD.DASHBOARD' | translate}}</h1>
      <div class="spacer-right" style="flex: 1; max-width: 250px;"></div>
    </header>

    @if (isLoading()) {
      <div class="loading-state"><p>{{'DASHBOARD.LOADING' | translate}}</p></div>
    }

    @if (!isLoading() && !festivalId()) {
      <div class="empty-state" style="text-align: center; padding: 40px; border: 2px dashed #ccc; border-radius: 12px; margin-top: 20px;">
        <mat-icon style="font-size: 48px; width: 48px; height: 48px; color: #ccc; margin-bottom: 16px;">event_busy</mat-icon>
        <h2>Aucun festival en cours</h2>
        <p>Vous devez définir un festival sur "En cours" depuis l'administration pour gérer sa programmation.</p>
        <button mat-flat-button color="primary" routerLink="/admin/festivals" style="margin-top: 16px;">
          Retour à l'administration
        </button>
      </div>
    }

    @if (!isLoading() && festivalId() && performanceGroups().length === 0) {
      <div class="empty-state">
        <p>{{'DASHBOARD.NOTHING' | translate}}</p>
        <button mat-button color="primary" (click)="navigateToAdd()">{{'DASHBOARD.ADD' | translate}}</button>
      </div>
    }

    @for (group of performanceGroups(); track group.date) {
      <section class="admin-section">
        
        <h2 class="section-label">
          {{ group.date | date:'EEEE d MMMM' : undefined : currentLang() | titlecase }}
        </h2>
        
        <div class="grid-table-container">
          <table mat-table [dataSource]="group.performances" class="festify-grid-table">

            <ng-container matColumnDef="artist">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.ARTIST' | translate}} </th>
              <td mat-cell *matCellDef="let perf" class="bold-text"> 
                {{ perf.artist?.name || 'Inconnu' }} 
              </td>
            </ng-container>

            <ng-container matColumnDef="title">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.TITLE' | translate}} </th>
              <td mat-cell *matCellDef="let perf"> {{ perf.title }} </td>
            </ng-container>

            <ng-container matColumnDef="stage">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.STAGE' | translate}} </th>
              <td mat-cell *matCellDef="let perf"> {{ perf.stage?.name || 'N/A' }} </td>
            </ng-container>

            <ng-container matColumnDef="start_at">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.START' | translate}} </th>
              <td mat-cell *matCellDef="let perf"> 
                {{ perf.start_at | date:'HH:mm' : undefined : currentLang() }} 
              </td>
            </ng-container>

            <ng-container matColumnDef="end_at">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.END' | translate}} </th>
              <td mat-cell *matCellDef="let perf"> 
                {{ perf.end_at | date:'HH:mm' : undefined : currentLang() }} 
              </td>
            </ng-container>

             <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef> {{'DASHBOARD.NOTE' | translate}} </th>
              <td mat-cell *matCellDef="let perf" class="desc-cell">
                {{ perf.description | slice:0:25 }}{{ perf.description && perf.description.length > 25 ? '...' : '' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="text-center"> {{'DASHBOARD.ACTION' | translate}} </th>
              <td mat-cell *matCellDef="let perf" class="action-cell">
                <button class="icon-btn edit" (click)="navigateToEdit(perf.id!)" title="Modifier">
                  <mat-icon>edit_square</mat-icon>
                </button>
                <button class="icon-btn trash" (click)="deletePerformance(perf.id!)" title="Supprimer">
                  <mat-icon>delete_outline</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </section>
    }
  </main>
</div>

<ng-template #confirmDialogTemplate>
  <h2 mat-dialog-title>Confirmation de suppression</h2>
  <mat-dialog-content>
    <p>Êtes-vous sûr de vouloir supprimer définitivement cette performance ? Cette action est irréversible.</p>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close>Annuler</button>
    <button mat-flat-button color="warn" [mat-dialog-close]="true">Supprimer</button>
  </mat-dialog-actions>
</ng-template>