<mat-card class="perf-card">

  @if (isEditMode()) {
    <button mat-flat-button 
            type="button" 
            class="delete-btn-top" 
            (click)="onDelete()"
            [disabled]="isLoading()">
      <mat-icon>delete_forever</mat-icon> SUPPRIMER
    </button>
  }
  <h2>{{ isEditMode() ? 'Modifier l\'hébergement' : 'Nouvel hébergement' }}</h2>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="perf-form">
    
    @if (serverErrors().length > 0) {
      <div class="form-error">
        @for (error of serverErrors(); track $index) {
          <div>{{ error }}</div>
        }
      </div>
    }

    <div class="grid-row-2">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nom de l'hébergement</mat-label>
        <input matInput formControlName="name" placeholder="Ex: Grand Hôtel" maxlength="100" #nameInput>
        <mat-hint align="end">{{ nameInput.value.length }} / 100</mat-hint>
        @if (form.get('name')?.hasError('required')) { <mat-error>Requis</mat-error> }
        @if (form.get('name')?.hasError('maxlength')) { <mat-error>Maximum 100 caractères</mat-error> }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Catégorie</mat-label>
        <mat-select formControlName="category">
          <mat-option [value]="0">Camping</mat-option>
          <mat-option [value]="1">Hotel</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Adresse</mat-label>
      <input matInput formControlName="address" maxlength="255" #addrInput>
      <mat-hint align="end">{{ addrInput.value.length }} / 255</mat-hint>
      @if (form.get('address')?.hasError('required')) { <mat-error>Requis</mat-error> }
      @if (form.get('address')?.hasError('maxlength')) { <mat-error>Maximum 255 caractères</mat-error> }
    </mat-form-field>

    <div class="grid-row-3">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Coordonnées (Lat, Long)</mat-label>
        <input matInput 
              placeholder="46.609, -72.704" 
              formControlName="coordinates">
        @if (form.get('coordinates')?.errors?.['pattern']) {
          <mat-error>
            Format invalide. <strong>46.609, -72.704</strong>
          </mat-error>
        }
      </mat-form-field>

      <div class="toggle-container">
        <mat-slide-toggle formControlName="shuttle">Navette</mat-slide-toggle>
      </div>
      <div></div> 
    </div>

    <div class="grid-row-3">
      <div class="grid-row-2">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Temps (Voiture)</mat-label>
          <input matInput type="time" formControlName="time_car">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Temps (Marche)</mat-label>
          <input matInput type="time" formControlName="time_walk">
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Commission (%)</mat-label>
        <input matInput type="number" formControlName="commission" min="0" max="29.99">
        
        @if (form.get('commission')?.hasError('min')) {
          <mat-error>La commission doit être au moins <strong>0%</strong></mat-error>
        }
        @if (form.get('commission')?.hasError('max')) {
          <mat-error>La commission doit être strictement <strong>inférieure à 30%</strong></mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-actions">
      <button 
          mat-stroked-button type="button" 
          [routerLink]="isEditMode() ? ['/accommodations-details', accommodationId()] : ['/accommodations']"
          [queryParams]="{ category: getCategoryString(form.get('category')?.value) }"
          class="action-btn cancel-btn">
        Annuler
      </button>
      <button mat-flat-button color="accent" type="submit" class="action-btn submit-btn" [disabled]="form.invalid || isLoading()">
        @if (isLoading()) {
          <span>Traitement...</span> 
        } @else {
          {{ isEditMode() ? 'Mettre à jour' : 'Enregistrer' }}
        }
      </button>
    </div>
  </form>
</mat-card>